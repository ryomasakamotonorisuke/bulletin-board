# 権限システムの設定ガイド

## 実装内容

### 1. 管理者権限の整理

#### 管理者の権限
- ✅ ユーザーの作成と削除
- ✅ すべての投稿の編集・削除
- ✅ ユーザー管理（管理者権限の付与・削除）
- ✅ 投稿管理（投稿の閲覧・削除）
- ✅ ユーザー招待機能

#### ユーザーの権限
- ✅ 自分の投稿の作成・編集・削除
- ✅ いいね機能
- ✅ コメント機能
- ✅ 人気投稿の閲覧

### 2. UIの変更

#### 管理者ボタンの表示条件
- プロフィールで`is_admin = TRUE`の場合のみ「管理者ページ」ボタンを表示
- Headerコンポーネントで権限をチェック

#### 投稿の編集・削除ボタン
- 投稿の所有者：編集・削除ボタンを表示
- 管理者：すべての投稿に編集・削除ボタンを表示
- 他のユーザー：編集・削除ボタンは表示しない

### 3. 実装されたファイル

#### 新規作成
- `src/types/index.ts` - 型定義
- `src/hooks/useAdminUsers.ts` - ユーザー管理用のカスタムフック
- `supabase-rls-policies.sql` - RLSポリシーの更新

#### 更新
- `src/components/PostCard.tsx` - 管理者が全投稿を編集・削除可能に
- `src/components/Header.tsx` - 管理者ボタンの表示制御
- `src/hooks/useAdmin.ts` - 管理者権限のチェック機能

### 4. データベースの設定

#### RLSポリシーの適用

Supabaseのダッシュボードで以下を実行：

1. `supabase-enhanced-schema.sql` を実行
2. `supabase-rls-policies.sql` を実行

これにより：
- 管理者が全投稿の編集・削除が可能
- ユーザーは自分の投稿のみ編集・削除可能
- コメントにも同様の権限設定

#### ユーザーへの管理者権限の付与

```sql
-- 既存のユーザーを管理者にする
UPDATE profiles 
SET is_admin = TRUE 
WHERE id = 'ユーザーID';

-- 社員として設定
UPDATE profiles 
SET is_employee = TRUE 
WHERE id = 'ユーザーID';
```

### 5. 使用方法

#### 一般ユーザー

1. ログイン
2. 投稿の作成
3. 自分の投稿の編集・削除
4. いいね・コメント機能の利用

#### 管理者

1. 管理者権限でログイン
2. Headerのユーザーメニューから「管理者ページ」をクリック
3. 以下の操作が可能：
   - 管理者ユーザーの作成
   - ユーザー管理（権限の付与・削除）
   - 投稿管理（全投稿の削除）
   - ユーザー招待

### 6. 権限チェックの仕組み

#### フロントエンド
- `useAdmin`フックで管理者権限をチェック
- `profiles`テーブルの`is_admin`カラムを参照

#### バックエンド（Supabase RLS）
- 投稿の編集：所有者または管理者
- 投稿の削除：所有者または管理者
- ユーザー管理：管理者のみ

### 7. セキュリティ

#### データベースレベル
- RLSポリシーで権限を制御
- 管理者かどうかはプロフィールテーブルで確認

#### アプリケーションレベル
- 管理者ボタンは権限チェック後に表示
- 投稿の編集・削除ボタンも権限チェック後に表示
- 不正アクセスを防止

## テスト手順

### 1. 一般ユーザーとして
- [ ] ログインできる
- [ ] 投稿を作成できる
- [ ] 自分の投稿を編集・削除できる
- [ ] 他のユーザーの投稿は編集・削除できない
- [ ] いいね・コメントができる
- [ ] 管理者ボタンが表示されない

### 2. 管理者として
- [ ] ログインできる
- [ ] 管理者ボタンが表示される
- [ ] 管理者画面にアクセスできる
- [ ] すべての投稿を編集・削除できる
- [ ] ユーザー管理ができる
- [ ] 投稿管理ができる
- [ ] ユーザー招待ができる

## トラブルシューティング

### 問題：管理者ボタンが表示されない

**解決策**:
```sql
UPDATE profiles 
SET is_admin = TRUE 
WHERE id = 'ユーザーID';
```

ブラウザをリフレッシュ。

### 問題：管理者が投稿を編集できない

**解決策**:
1. RLSポリシーが正しく適用されているか確認
2. `supabase-rls-policies.sql` を実行

### 問題：ユーザーがログインできない

**解決策**:
```sql
UPDATE profiles 
SET is_employee = TRUE 
WHERE id = 'ユーザーID';
```

これで社員としてログイン可能に。

## まとめ

権限システムを実装しました。管理者とユーザーで適切に権限が分かれ、セキュリティも確保されています。

